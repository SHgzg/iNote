# Typography 工作流程指南

## 一、开发环境设置

### 1.1 环境要求
```bash
# 检查 Node.js 版本（需要 >= 18.0.0）
node --version

# 检查 pnpm 版本（需要 >= 8.0.0）
pnpm --version

# 如果未安装 pnpm
npm install -g pnpm@latest
```

### 1.2 项目初始化
```bash
# 克隆项目
git clone <repository-url>
cd typography

# 安装依赖
pnpm install

# 构建所有包
pnpm run build

# 运行测试确保环境正常
pnpm run test
```

### 1.3 IDE 配置

**VS Code 推荐插件**
- TypeScript Importer
- Vetur / Vue Language Features (Volar)
- ESLint
- Prettier
- GitLens

**VS Code 配置**
```json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true
  },
  "typescript.preferences.importModuleSpecifier": "relative"
}
```

## 二、日常开发流程

### 2.1 创建功能分支
```bash
# 切换到主分支并拉取最新代码
git checkout main
git pull origin main

# 创建功能分支
git checkout -b feature/data-source-validation
```

### 2.2 开发阶段

**启动开发环境**
```bash
# CLI 工具开发
pnpm run dev:cli

# 文档开发
pnpm run dev:docs

# 示例项目开发
pnpm run dev:playground
```

**实时类型检查**
```bash
# 在另一个终端运行类型检查
pnpm run typecheck --watch
```

**测试驱动开发**
```bash
# 运行特定测试文件
pnpm run test packages/core/src/compiler.test.ts

# 监听模式运行测试
pnpm run test --watch

# 生成覆盖率报告
pnpm run test:coverage
```

### 2.3 代码提交前检查
```bash
# 完整的提交前检查脚本
pnpm run pre-commit

# 手动执行检查
pnpm run typecheck
pnpm run test
pnpm run lint
pnpm run format
```

## 三、发布流程

### 3.1 版本管理
```bash
# 检查当前版本
pnpm run version:check

# 创建变更集
pnpm run changeset

# 查看待发布的变更
pnpm run changeset:status

# 更新版本号
pnpm run version:update
```

### 3.2 构建和发布
```bash
# 构建所有包
pnpm run build

# 发布到 npm
pnpm run release

# 仅构建不发布（用于测试）
pnpm run build:release
```

### 3.3 发布后验证
```bash
# 验证安装
npm install @typography/core@latest

# 验证功能
npx @typography/cli --version
```

## 四、常用开发命令

### 4.1 核心开发命令
```bash
# 依赖管理
pnpm add <package>                    # 添加到根依赖
pnpm add <package> --filter @typography/core  # 添加到特定包
pnpm remove <package>                 # 移除依赖

# 脚本执行
pnpm run <script>                     # 运行根目录脚本
pnpm run <script> --filter <package>  # 运行特定包脚本

# 构建相关
pnpm run build                        # 构建所有包
pnpm run build --filter <package>     # 构建特定包
pnpm run build:watch                  # 监听模式构建

# 测试相关
pnpm run test                         # 运行所有测试
pnpm run test --filter <package>      # 运行特定包测试
pnpm run test --ui                    # 可视化测试界面
```

### 4.2 包特定命令
```bash
# @typography/core
pnpm run dev:core           # 核心包开发模式
pnpm run test:core          # 核心包测试

# @typography/cli
pnpm run dev:cli            # CLI 开发模式
pnpm run test:cli           # CLI 测试

# @typography/components
pnpm run dev:components     # 组件开发模式
pnpm run test:components    # 组件测试

# @typography/docs
pnpm run dev:docs           # 文档开发（Storybook）
pnpm run build:docs         # 构建文档

# @typography/playground
pnpm run dev:playground     # 示例项目开发
pnpm run build:playground   # 构建示例项目
```

## 五、故障排除

### 5.1 常见问题

**依赖问题**
```bash
# 清理依赖重新安装
rm -rf node_modules packages/*/node_modules
pnpm install

# 清理 pnpm 存储
pnpm store prune
```

**类型错误**
```bash
# 重新生成类型文件
pnpm run typecheck:fix

# 清理 TypeScript 缓存
rm -rf packages/*/dist packages/*/tsbuildinfo
pnpm run build
```

**测试失败**
```bash
# 更新快照
pnpm run test --updateSnapshot

# 运行测试并显示详细输出
pnpm run test --verbose
```

**构建失败**
```bash
# 增量构建可能出现问题，使用强制重建
pnpm run build --force

# 清理构建产物
pnpm run clean
pnpm run build
```

### 5.2 调试技巧

**使用 TypeScript 编译器调试**
```bash
# 编译特定文件查看具体错误
npx tsc --noEmit packages/core/src/compiler.ts

# 生成详细构建信息
pnpm run build --verbose
```

**使用 VS Code 调试**
```json
{
  "type": "node",
  "request": "launch",
  "name": "Debug Core",
  "program": "${workspaceFolder}/packages/core/src/index.ts",
  "outFiles": ["${workspaceFolder}/packages/core/dist/**/*.js"],
  "runtimeArgs": ["-r", "ts-node/register"]
}
```

## 六、性能优化

### 6.1 开发优化

**提高构建速度**
```bash
# 使用增量构建
pnpm run build --incremental

# 并行构建
pnpm run build --parallel

# 只构建变更的包
pnpm run build --since=main
```

**减少测试时间**
```bash
# 只运行相关测试
pnpm run test --related

# 并行运行测试
pnpm run test --parallel

# 使用测试缓存
pnpm run test --cache
```

### 6.2 监控和分析

**构建分析**
```bash
# 分析包大小
pnpm run analyze

# 分析依赖关系
pnpm run graph

# 依赖树可视化
pnpm run deps:graph
```

**性能监控**
```bash
# 构建时间统计
pnpm run build --timing

# 内存使用分析
pnpm run build --profile
```

## 七、团队协作

### 7.1 代码审查流程

1. **创建 Pull Request**
   - 使用清晰的标题描述变更
   - 在描述中说明变更原因和影响
   - 关联相关 Issue

2. **代码审查要求**
   - 至少一个团队成员审查
   - 通过所有自动化检查
   - 代码覆盖率不能降低

3. **合并要求**
   - 解决所有审查意见
   - 保持分支最新（rebase main）
   - 确认 CI/CD 通过

### 7.2 文档更新

```bash
# 更新 API 文档
pnpm run docs:generate

# 更新变更日志
pnpm run changelog

# 更新 README
pnpm run readme:update
```

## 八、CI/CD 流程

### 8.1 持续集成

**GitHub Actions 工作流**
- 代码推送触发自动构建
- 运行所有测试和类型检查
- 生成覆盖率报告
- 部署文档到预览环境

### 8.2 持续部署

**自动发布流程**
1. 版本号更新
2. 构建所有包
3. 发布到 npm
4. 部署文档站点
5. 创建 GitHub Release

## 九、最佳实践

### 9.1 分支管理
- 功能开发使用 `feature/` 前缀
- 修复使用 `fix/` 前缀
- 发布使用 `release/` 前缀
- 及时删除已合并的分支

### 9.2 提交规范
- 遵循 Conventional Commits
- 一个提交只做一件事
- 提交信息清晰描述变更

### 9.3 版本管理
- 使用 Semantic Versioning
- 通过 Changesets 管理版本
- 及时更新 CHANGELOG.md

---

## 工具参考

### 常用工具命令
- `pnpm` - 包管理器
- `vitest` - 测试框架
- `typescript` - 类型检查
- `eslint` - 代码检查
- `prettier` - 代码格式化
- `changesets` - 版本管理

### 配置文件位置
- `pnpm-workspace.yaml` - Monorepo 配置
- `tsconfig.base.json` - TypeScript 基础配置
- `eslint.config.js` - ESLint 配置
- `.prettierrc` - Prettier 配置
- `.changeset/` - 版本变更配置

遵循这些工作流程将确保开发过程的顺畅和代码质量的一致性。